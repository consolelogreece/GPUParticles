<!-- This is a learning exercise inspired and hugely helped by: https://blog.mapbox.com/how-i-built-a-wind-map-with-webgl-b63022b5537f -->

<body>
    <div id="particlesApp" class="centered">
        <div id="particlesDisplayContainer">
            <canvas id="c"></canvas>
        </div>
    </div>
    <div id="menuToggle" onclick="toggleMenu()">
        â˜°
    </div>
    <div id="menu" style="display: none;">
        <div id="githubContainer">               
            <a href="https://github.com/consolelogreece/GPUParticles" target="_blank" title="GitHub">
                <svg id="githubSVG" viewBox="0 0 16 16">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>   
        </div>
        <div id="controls">
            <h3 class="controlAreaLabel">Formula</h3>      
            <div class="controlElementContainer" id="formulaContainer">
                <textarea id="formula" rows="4" cols="50" oninput="onFormulaChange()"></textarea>

                <h4 class="controlLabel">Select a preset: </h4> 
                <select name="formulaPresets" id="formulaPresets" onchange="onPresetChanged()" class="inputBox" id="formulaPresets">
                  <option value="Swirls">Swirls</option>
                  <option value="Milkyway">Milkyway</option>
                  <option value="Parallax">Parallax </option>
                </select> 
            </div>
            <h3 class="controlAreaLabel">Configuration</h3>
            <div class="controlElementContainer" id="particleConfigContainer">
                <div class="subcontrolContainer">
                    <h4 class="controlLabel">Count: <span id="particleCountLabel"></span></h4> 
                    <input type="range" min="1" max="1024" value="150" class="slider" oninput="onParticleCountInput()" id="particleCountRange">
                </div>
                <div class="subcontrolContainer">
                    <h4 class="controlLabel">Size <span id="particleSizeLabel"></span></h4> 
                    <input type="range" min="1" max="20" value="1" class="slider" oninput="onParticleSizeInput()" id="particleSizeRange">
                </div>
                <div class="subcontrolContainer">
                    <h4 class="controlLabel">Trail length <span id="particleTrailLengthLabel"></span></h4> 
                    <input type="range" min="0" max="100" value="80" class="slider" oninput="onParticleTrialLengthInput()" id="particleTrailLengthRange">
                </div>
                <div class="subcontrolContainer">
                    <h4 class="controlLabel">Respawn threshold <span id="particleRespawnRateLabel"></span></h4> 
                    <input type="range" min="0" max="10000" value="9940" class="slider" oninput="onParticleRespawnRateLengthInput()" id="particleRespawnRateRange">
                </div>
            </div>
            <div class="controlElementContainer" id="colourConfigContainer">
                <div class="subcontrolContainer">
                    <h4 class="controlLabel">Particle</h4>
                    <input type="color" class="colourpicker" id="particleColour"  onchange="onParticleColourChange()" value="#ffa366">
                </div>
                <div class="subcontrolContainer">
                    <h4 class="controlLabel">Background</h4>
                    <input type="color" class="colourpicker" id="backgroundColour" value="#1a0a00">
                </div>             
            </div>
            <div class="controlElementContainer" id="imgConfigContainer">
                <div class="subcontrolContainer">
                    <h4 class="controlLabel">Image URL  <span class="infoLabel">(The particles will paint this image)</span></h4> 
                    <input id="imageUrl" class="inputBox" placeholder="Click for choices/enter your own url (imgur.com/example.png)" type="text" list="images" />
                    <datalist id="images">
                        <option value="https://i.imgur.com/QALgrNJ.jpeg">Mountain River</option>
                        <option value="https://i.imgur.com/nE2WMAF.jpeg">Indian Sunset</option>
                        <option value="https://i.imgur.com/cmAtU7Y.jpeg">Graffiti</option>
                        <option value="https://i.imgur.com/E6e6vjP.jpeg">Space Cat</option>
                        <option value="https://i.imgur.com/rel7mXd.jpeg">Fantasy</option>
                        <option value="https://i.imgur.com/8tcxHWh.jpeg">Low Poly Mountains</option>
                    </datalist>
                </div>               
            </div> 
        </div>
        <div id="buttonsContainer">
            <button id="btnUpdate" class="btn buttonWood" onclick="update()">Update</button>
            <button id="btnReset" class="btn buttonWood" onclick="reset()">Reset</button>
        </div>
        </div>
    </div>
</body>

<script src="./Scripts/utils.js"></script>
<script src="./Scripts/Presets.js"></script>
<script src="./Shaders/Draw_Particles_Shader.js"></script>
<script src="./Shaders/Fade_Screen_Texture_Shader.js"></script>
<script src="./Shaders/Draw_To_Screen_Texture_Shader.js"></script>
<script src="./Shaders/Update_Particles_Shader.js"></script>
<script src="./Scripts/ParticlesExperiment.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css">

<script>
    var formulaEl = document.getElementById("formula");
    var countEl = document.getElementById("particleCountRange");
    var sizeEl =  document.getElementById("particleSizeRange");
    var trailLengthEl = document.getElementById("particleTrailLengthRange");
    var respawnRateEl = document.getElementById("particleRespawnRateRange");
    var particleColourEl = document.getElementById("particleColour");
    var backgroundColourEl = document.getElementById("backgroundColour");
    var imageUrlEl =  document.getElementById("imageUrl");

    var defaultText = ("//currentPosition is passed in.\n//Coordinates range from 0 to 1000.\n//All numbers must be floats (decimals)\n\nvec2 newPosition = vec2(0);\n\n" +
    "newPosition.x = currentPosition.x + sin(currentPosition.y / 100.0);\n\n" + 
    "newPosition.y = currentPosition.y + sin(currentPosition.x / 100.0);\n\n" +
    "return newPosition;");

    var requestAnimationFrameReference;

    function draw()
    {
        if (!particles) return;
        
        particles.draw();
        
        // This tells the browser to keep rerunning this function whenever it deems fit (typically the refresh rate of the monitor).
        requestAnimationFrameReference = requestAnimationFrame(draw);
    }

    var loading = false;
    async function update(img)
    {
        if (loading) return;
        loading = true;
        cancelAnimationFrame(requestAnimationFrameReference);

        var src = formulaEl.value;
        var particleCount = countEl.value;
        var particleSize = sizeEl.value;
        var trailLength = trailLengthEl.value;
        var respawnRate = respawnRateEl.value;
        var particleColour = hexToRGB(particleColourEl.value);
        var backgroundColour = hexToRGB(backgroundColourEl.value);
        var imageUrl = imageUrlEl.value;

        var img = await loadImage(imageUrl);

        particles = new ParticlesExperiment(document.getElementById("c").getContext("webgl2"), particleCount, particleSize, trailLength, 
            respawnRate, particleColour, backgroundColour, img, window.innerWidth , window.innerHeight);

        var updateParticlesProgramSrc = GetUpdateParticlesProgramSrc(src);

        particles.setupUpdateParticlesProgram(updateParticlesProgramSrc.vert, updateParticlesProgramSrc.frag); 

        loading = false;

        draw();
    }

    function reset()
    {
        formulaEl.value = defaultText;
        countEl.value = 100;
        sizeEl.value = 1;
        trailLengthEl.value = 80;
        respawnRateEl.value = 9940;
        particleColourEl.value = "#ffa366";
        backgroundColourEl.value = "#1a0a00";
        imageUrlEl.value = "";
        presetEl.selectedIndex = 1;

        onParticleCountInput();
        onParticleSizeInput();
        onParticleTrialLengthInput();
        onParticleRespawnRateLengthInput();
        onPresetChanged();

        update();
    }

    function hexToRGB(value)
    {
        // Thanks to: https://stackoverflow.com/questions/36697749/html-get-color-in-rgb
        var value = value.match(/[A-Za-z0-9]{2}/g);
        value = value.map(function(v) { return parseInt(v, 16) });
        return value;
    }

    function onParticleCountInput()
    {
       var lbl = document.getElementById("particleCountLabel");

       lbl.innerHTML = countEl.value * countEl.value;
    }

    function onParticleSizeInput()
    {
        var lbl = document.getElementById("particleSizeLabel");

        lbl.innerHTML = sizeEl.value;
    }

    function onParticleTrialLengthInput()
    {
        var lbl = document.getElementById("particleTrailLengthLabel");

        lbl.innerHTML = trailLengthEl.value;
    }

    function onParticleRespawnRateLengthInput()
    {
        var lbl = document.getElementById("particleRespawnRateLabel");

        lbl.innerHTML = respawnRateEl.value / 10000;
    }

    function onParticleColourChange()
    {
        imageUrlEl.value = "";
    }

    function onFormulaChange()
    {
        presetEl.selectedIndex = -1;
    }

    var presetEl = document.getElementById("formulaPresets");
    function onPresetChanged()
    {
        var val = presetEl.value;
        formulaEl.value = presets[val];
    }

    const loadImage = (imageUrlEl) => new Promise(resolve => 
    {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null)
        img.crossOrigin = 'anonymous';
        img.src = imageUrlEl;
        
        return null;
    })

    var menuElement= document.getElementById("menu");
    function toggleMenu() 
    {
        if (menuElement.style.display === "none") {
            menuElement.style.display = "block";
        } else {
            menuElement.style.display = "none";
        }
    }

    var particles;

    var resizeCanvas;
    window.onresize = function(){
        clearTimeout(resizeCanvas);
        resizeCanvas = setTimeout(update, 250);
    };

    reset();    
</script>

<!--
    todo: delta time for consistent movement regardless of framerate
    feature ideas: 
        add collisions using a collision texture 
-->