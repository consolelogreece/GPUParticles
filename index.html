<!-- This is a learning exercise inspired and hugely helped by: https://blog.mapbox.com/how-i-built-a-wind-map-with-webgl-b63022b5537f -->

<body>
    <div id="particlesApp" class="centered">
        <div id="particlesDisplayContainer">
            <canvas id="c"></canvas>
        </div>
        <div id="controls">
            <textarea id="formula" rows="4" cols="50">
                
            </textarea>
            <button class="btn buttonWood" onclick="update()">Update</button>
            <button class="btn buttonWood" onclick="reset()">Reset</button>
        </div>
    </div>
</body>

<script src="./utils.js"></script>
<script src="./Shaders/Draw_Particles_Shader.js"></script>
<script src="./Shaders/Fade_Screen_Texture_Shader.js"></script>
<script src="./Shaders/Draw_To_Screen_Texture_Shader.js"></script>
<script src="./Shaders/Update_Particles_Shader.js"></script>
<script src="./Scripts/ParticlesExperiment.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css">

<script>
    function draw()
    {
        particles.draw();
        
        // This tells the browser to keep rerunning this function whenever it deems fit (typically the refresh rate of the monitor).
        requestAnimationFrame(draw);
    }

    function resize()
    {
        // Keep it square because it looks cooler.
        var dimension = window.innerWidth;
        if (window.innerHeight < window.innerWidth) dimension = window.innerHeight;
        var dimensionSizePixels = dimension / 100 * 85;

        particles.resize(dimensionSizePixels, dimensionSizePixels)
    }

    var formulaEl = document.getElementById("formula");

    var defaultText = ("//currentPosition is passed in.\n//Coordinates range from 0 to 1000.\n\nvec2 newPosition = vec2(0);\n\n" +
    "newPosition.x = currentPosition.x + sin(currentPosition.y / 100.0)\n\n" + 
    "newPosition.y = currentPosition.y + sin(currentPosition.x / 100.0)\n\n" +
    "return newPosition;");        

    function update()
    {
        var src = formulaEl.value;
        
        var updateParticlesProgramSrc = GetUpdateParticlesProgramSrc(src);

        particles.setupUpdateParticlesProgram(updateParticlesProgramSrc.vert, updateParticlesProgramSrc.frag); 
    }

    function reset()
    {
        formulaEl.value = defaultText;
        
        update();
    }

    formulaEl.value = defaultText;

    var particles = new ParticlesExperiment(document.getElementById("c").getContext("webgl2", {preserveDrawingBuffer: false}));

    window.addEventListener('resize', resize); 

    resize();
    draw();
</script>

<!--
    feature ideas: 
        particles paint a picture
        add controls to change various settings/configs
            particles size
            particle count
            particle colour
            background colour
            trail length (dimming effect)
        add collisions using a collision texture described in that one article 
-->